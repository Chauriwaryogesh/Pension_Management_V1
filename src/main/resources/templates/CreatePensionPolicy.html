<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Pension Policy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
        }
        .form-section {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b; /* Slate 800 */
            margin-bottom: 1.25rem;
            border-bottom: 1px solid #e2e8f0; /* Slate 200 */
            padding-bottom: 0.75rem;
        }
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569; /* Slate 600 */
            margin-bottom: 0.25rem;
        }
        .input-field {
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* Slate 300 */
            border-radius: 6px;
            transition: all 0.2s;
            width: 100%;
            background-color: #ffffff;
            font-size: 0.875rem;
        }
        .input-field:focus {
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        .input-field:disabled {
            background-color: #f8fafc; /* Slate 50 */
            color: #64748b; /* Slate 500 */
            cursor: not-allowed;
        }
        
        /* --- Button Styles --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            padding: 0.5rem 1rem; /* Reduced padding */
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            border: 1px solid transparent;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn .fas, .btn .far {
            margin-right: 0.6rem;
            font-size: 0.9em;
        }

        /* --- New Redesigned Primary Button --- */
        .btn-glow {
            background-image: linear-gradient(to right, #4f46e5 0%, #818cf8 51%, #4f46e5 100%);
            background-size: 200% auto;
            color: white;
            border: none;
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.4);
        }
        .btn-glow:hover:not(:disabled) {
            background-position: right center;
            box-shadow: 0 6px 20px 0 rgba(79, 70, 229, 0.5);
            transform: translateY(-2px);
        }

        .btn-primary { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #10b981; color: white; border-color: #10b981; }
        .btn-secondary:hover:not(:disabled) { background-color: #059669; }
        .btn-success { background-color: #22c55e; color: white; border-color: #22c55e; }
        .btn-success:hover:not(:disabled) { background-color: #16a34a; }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-light { background-color: #64748b; color: white; border-color: #64748b; }
        .btn-light:hover:not(:disabled) { background-color: #475569; }
        
        /* Modals and Loading */
        .notification-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }
        .notification-modal.active {
            display: flex; align-items: center; justify-content: center;
        }
        .notification-content, .search-modal-content {
            background-color: #fefefe; padding: 25px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; animation: fadeIn 0.3s ease-out;
        }
        .search-modal-content {
            max-width: 800px; text-align: left;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1); border-left-color: #ffffff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .customer-result-row {
            cursor: pointer; transition: background-color 0.15s ease-in-out;
        }
        .customer-result-row:hover {
            background-color: #eff6ff; /* blue-50 */
        }
    </style>
</head>
<body>

    <!-- Redesigned Header -->
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                         <i class="fas fa-shield-alt text-2xl text-cyan-400"></i>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-4 flex items-baseline space-x-4">
                            <span class="text-white px-3 py-2 text-md font-semibold">Pension Management Services V1</span>
                            <a href="#" class="text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                            <a href="#" class="bg-slate-800 text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Enrollment</a>
                            <a href="#" class="text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Policies</a>
                            <a href="#" class="text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Reports</a>
                        </div>
                    </div>
                </div>
                 <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <button type="button" class="bg-slate-800 p-1 rounded-full text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-white">
                            <span class="sr-only">View notifications</span>
                            <i class="far fa-bell"></i>
                        </button>
                        <div class="ml-3 relative flex items-center">
                             <span id="userCodeDisplay" class="text-gray-300 text-sm font-medium mr-3"></span>
                            <div>
                                <button type="button" class="max-w-xs bg-slate-800 rounded-full flex items-center text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-white" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                    <span class="sr-only">Open user menu</span>
                                    <img class="h-8 w-8 rounded-full" src="https://placehold.co/100x100/E2E8F0/475569?text=U" alt="User placeholder image">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <div class="main-content container mx-auto p-4 md:p-8 max-w-7xl">
        <h1 class="text-3xl font-bold text-slate-800 mb-6">
            New Pension Policy Enrollment
        </h1>
        
        <form id="pensionPolicyForm" class="space-y-6">

            <div class="form-section">
                <h2 class="flex items-center"><i class="fas fa-user-circle mr-3 text-lg text-indigo-500"></i>Customer Profile & Lookup</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                    <div class="md:col-span-2">
                        <label for="customerNumberInputForSearch" class="label">Customer No. (Search)</label>
                        <input type="text" id="customerNumberInputForSearch" class="input-field" placeholder="Enter Customer ID" onkeyup="checkCustomerNumber(this.value)">
                    </div>
                    <div>
                        <button type="button" id="fetchCustomerBtn" onclick="fetchCustomerDetails()" class="btn btn-primary" disabled>
                            <i class="fas fa-database"></i>Fetch Details
                        </button>
                    </div>
                    <div>
                        <button type="button" id="searchCustomerBtn" onclick="showSearchCustomerModal()" class="btn btn-secondary">
                            <i class="fas fa-search"></i>Find Customer
                        </button>
                    </div>
                </div>
                 <div id="customerStatus" class="text-sm -mt-4 mb-4 h-5"></div>
                
                <div class="border-t border-slate-200 pt-4 mt-6 text-sm text-center space-y-2">
                     <p>
                        <a href="#" onclick="event.preventDefault(); showCreateCustomerModal();" class="text-indigo-600 hover:underline font-medium">Want to create a new customer?</a>
                     </p>
                     <p>
                        <a href="#" onclick="event.preventDefault(); showBankAccountModal();" class="text-indigo-600 hover:underline font-medium">Missing bank details? Click here to add.</a>
                     </p>
                     <p>
                        <a href="#" onclick="event.preventDefault(); showEditCustomerModal();" class="text-indigo-600 hover:underline font-medium">Missing or incorrect customer details?</a>
                     </p>
                </div>


                <div id="customerDetailsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 border-t border-slate-200 pt-6 mt-6">
                     <div>
                        <label for="customerNumberForApi" class="label">Customer No.</label>
                        <input type="text" id="customerNumberForApi" required class="input-field" placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerFirstName" class="label">First Name</label>
                        <input type="text" id="customerFirstName" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerMiddleName" class="label">Middle Name</label>
                        <input type="text" id="customerMiddleName" class="input-field" placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerLastName" class="label">Last Name</label>
                        <input type="text" id="customerLastName" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>

                    <div>
                        <label for="customerDOB" class="label">Date of Birth</label>
                        <input type="date" id="customerDOB" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerEmail" class="label">Email Address</label>
                        <input type="email" id="customerEmail" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerPhone" class="label">Phone Number</label>
                        <input type="tel" id="customerPhone" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    
                    <div>
                        <label for="customerAadhar" class="label">Aadhar Number</label>
                        <input type="text" id="customerAadhar" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerPan" class="label">PAN Number</label>
                        <input type="text" id="customerPan" class="input-field" required placeholder="Auto-populated" disabled>
                    </div>
                    <div>
                        <label for="customerDrivingLicense" class="label">Driving License</label>
                        <input type="text" id="customerDrivingLicense" class="input-field" placeholder="Auto-populated" disabled>
                    </div>

                    <div class="md:col-span-3">
                        <label for="customerAddress" class="label">Address</label>
                        <textarea id="customerAddress" class="input-field h-20 resize-none" required placeholder="Auto-populated" disabled></textarea>
                    </div>
                </div>
            </div>

            <!-- Other form sections remain the same -->
            <div class="form-section" id="existingPoliciesSection" style="display:none;">
                <h2 class="flex items-center"><i class="fas fa-history mr-3 text-lg text-indigo-500"></i>Existing Policy Information</h2>
                <div id="existingPoliciesContainer" class="space-y-6"></div>
                <p id="noPoliciesMessage" class="text-gray-500 text-center py-4 hidden">No existing policies found for this customer.</p>
            </div>

            <div class="form-section">
                <h2 class="flex items-center"><i class="fas fa-file-contract mr-3 text-lg text-indigo-500"></i>Pension Policy Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                    <div>
                        <label for="policyName" class="label">Policy Name</label>
                        <select id="policyName" class="input-field" required onchange="handlePolicySelect(this.value)">
                            <option value="">-- Loading Policies --</option>
                        </select>
                    </div>
                    <div>
                        <label for="policyStartDate" class="label">Start Date</label>
                        <input type="date" id="policyStartDate" class="input-field" required>
                    </div>
					<div>
					 <label for="policyMaturityDate" class="label">Maturity Date</label>
					  <input type="date" id="policyMaturityDate" class="input-field" required>
					   </div>
                    <div>
                        <label for="policyTerm" class="label">Policy Term (Years)</label>
                        <input type="number" id="policyTerm" class="input-field" required min="5" max="50" placeholder="Auto-populated">
                    </div>
					<div>
				<label for="policyTotalInstallments" class="label">Policy TotalInstallments</label>
			 <input type="number" id="policyTotalInstallments" class="input-field" required min="1" max="50" placeholder="Auto-populated">
				</div>
				
				<div>
			<label for="policyInstallmentAmount" class="label">Policy Installments Amount</label>
			 <input type="number" id="policyInstallmentAmount" class="input-field" required  placeholder="Auto-populated">
			</div>
                    
                    <div>
                        <label for="premiumAmount" class="label">Premium Amount ($)</label>
                        <input type="number" id="premiumAmount" class="input-field"  placeholder="Auto-populated">
                    </div>
                    <div>
                        <label for="paymentFrequency" class="label">Payment Frequency</label>
                        <select id="paymentFrequency" class="input-field" required>
                            <option value="">Select Frequency</option>
                            <option value="MONTHLY">Monthly</option>
                            <option value="QUATERLY">Quarterly</option>
                            <option value="YEARLY">Yearly</option>
                        </select>
                    </div>
                    <div>
                        <label for="annuityPayoutOption" class="label">Annuity Payout Option</label>
                        <select id="annuityPayoutOption" class="input-field" required>
                            <option value="">Select Payout Type</option>
                            <option value="Life Annuity">Life Annuity</option>
                            <option value="Joint Life Annuity">Joint Life Annuity</option>
                            <option value="Annuity Certain">Annuity Certain</option>
                            <option value="Variable Annuity">Variable Annuity</option>
                        </select>
                    </div>
					<div>
					    <label for="policyStatus" class="label">Policy Status</label>
					    <select id="policyStatus" class="input-field" required>
					        <option value="ACTIVE" selected>Active</option>
					        <option value="LAPSED">Lapsed</option>
					        <option value="MATURED">Matured</option>
					        <option value="SURRENDERED">Surrendered</option>
					    </select>
					</div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="flex items-center"><i class="fas fa-hand-holding-usd mr-3 text-lg text-indigo-500"></i>Pension & Nominee Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                    <div>
                        <label for="benefitAge" class="label">Retirement/Benefit Age <span class="text-red-500">*</span></label>
                        <select id="benefitAge" class="input-field" required>
                            <option value="">Select Age</option>
                            <option value="65">65</option>
                            <option value="75">75</option>
                        </select>
                    </div>
                    <div>
                        <label for="nomineeName" class="label">Nominee Full Name</label>
                        <input type="text" id="nomineeName" class="input-field" required placeholder="Full Name">
                    </div>
                    <div>
                        <label for="nomineeRelationship" class="label">Nominee Relationship</label>
                        <select id="nomineeRelationship" class="input-field" required>
                            <option value="">Select Relationship</option>
                            <option value="Spouse">Spouse</option>
                            <option value="Child">Child</option>
                            <option value="Parent">Parent</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label for="nomineeAadhar" class="label">Nominee Aadhar Number</label>
                        <input type="text" id="nomineeAadhar" class="input-field" placeholder="Nominee's Aadhar">
                    </div>
					<div>
					<label for="nomineeContactNumber" class="label">Nominee Contact Number</label>
					 <input type="text" id="nomineeContact" class="input-field" required  max="10" placeholder="Nominee's Contact">
					 </div>
                    <div>
                        <label for="nomineePan" class="label">Nominee PAN Number</label>
                        <input type="text" id="nomineePan" class="input-field" placeholder="Nominee's PAN">
                    </div>
                    <div>
                        <label for="nomineeDrivingLicense" class="label">Nominee Driving License</label>
                        <input type="text" id="nomineeDrivingLicense" class="input-field" placeholder="Nominee's DL">
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-md font-semibold text-slate-800 mb-2 border-b pb-2">Policy Benefits (Riders)</h3>
                    <div id="benefitsContainer" class="space-y-3 mt-3"></div>
                    <button type="button" id="addBenefitBtn" class="mt-3 btn btn-warning">
                        <i class="fas fa-plus"></i> Add Policy Benefit
                    </button>
                    <p id="benefitError" class="text-red-500 text-sm mt-2 hidden">A selected benefit cannot be added again.</p>
                </div>
            </div>

            <div class="text-center pt-4 flex justify-center space-x-4">
                <button type="button" id="resetPolicyBtn" onclick="resetForm()" class="btn btn-light px-8">
                    <i class="fas fa-redo"></i> Reset Form
                </button>
                <button type="submit" id="submitPolicyBtn" class="btn btn-success px-8 disabled:opacity-50" disabled>
                    <span id="submitText">Create Policy</span>
                    <div id="loadingSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- Modals -->
    <div id="notificationModal" class="notification-modal">
        <div class="notification-content">
            <h3 id="notification-title" class="text-xl font-bold mb-3"></h3>
            <p id="notification-message" class="text-gray-600 mb-6"></p>
            <button id="notification-close-btn" class="btn btn-primary w-full">
                Close & Go to Admin Panel
            </button>
        </div>
    </div>
    
    <div id="createCustomerModal" class="notification-modal">
        <div class="notification-content">
            <h3 class="text-xl font-bold mb-3 text-indigo-600">Customer Creation Workflow</h3>
            <p class="text-gray-600 mb-6">This is a mock navigation. In a real application, this would redirect to the dedicated "Create New Customer" page.</p>
            <button onclick="closeCustomerModal()" class="btn btn-glow w-full">
                Close Mock & Continue
            </button>
        </div>
    </div>
	<div id="createBankAccountModal" class="notification-modal">
        <div class="notification-content">
            <h3 class="text-xl font-bold mb-3 text-indigo-600">Bank Account Creation</h3>
            <p class="text-gray-600 mb-6">This is a mock navigation. In a real application, this would redirect to the dedicated "Create New Bank Account" page for the customer.</p>
            <button onclick="closeBankAccountModal()" class="btn btn-glow w-full">Close Mock & Continue
            </button>
        </div>
    </div>
     <div id="editCustomerModal" class="notification-modal">
        <div class="notification-content">
            <h3 class="text-xl font-bold mb-3 text-indigo-600">Edit Customer Workflow</h3>
            <p class="text-gray-600 mb-6">This is a mock navigation. In a real application, this would redirect to a page to edit the currently loaded customer's details.</p>
            <button onclick="closeEditCustomerModal()" class="btn btn-glow w-full">
                Close Mock & Continue
            </button>
        </div>
    </div>
    
    <div id="searchCustomerModal" class="notification-modal">
        <div class="notification-content search-modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex justify-between items-center">
                <span><i class="fas fa-search mr-3"></i> Search Customer</span>
                <button onclick="closeSearchCustomerModal()" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div> <label for="searchName" class="label">Name</label> <input type="text" id="searchName" class="input-field" placeholder="Full or partial name"> </div>
                <div> <label for="searchEmail" class="label">Email</label> <input type="email" id="searchEmail" class="input-field" placeholder="Email address"> </div>
                <div> <label for="searchPhone" class="label">Phone Number</label> <input type="tel" id="searchPhone" class="input-field" placeholder="Phone number"> </div>
                <div> <label for="searchCustomerNo" class="label">Customer No</label> <input type="text" id="searchCustomerNo" class="input-field" placeholder="Customer ID"> </div>
            </div>
            <div class="text-center pt-2">
                <button type="button" id="executeSearchBtn" onclick="searchCustomers()" class="btn btn-primary">
                    <span id="searchText">Execute Search</span>
                    <div id="searchLoadingSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
            </div>
            <div class="mt-6">
                <h4 class="text-md font-semibold text-gray-800 mb-2 border-b pb-1">Search Results (<span id="resultCount">0</span>)</h4>
                <div id="searchResultsContainer" class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-inner max-h-64 overflow-y-auto">
                    <p id="initialSearchMessage" class="text-center text-gray-500 p-4">Enter search criteria and click Execute Search.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Redesigned Footer -->
    <footer class="bg-slate-800 text-slate-400 text-center py-4 mt-auto border-t border-slate-700">
        <p>Pension Management Services V1</p>
    </footer>


    <script>
        const PENSION_SERVICE_BASE_URL = 'http://localhost:9091/pensionServices';

        // DOM Element Declarations
        const form = document.getElementById('pensionPolicyForm');
        const benefitsContainer = document.getElementById('benefitsContainer');
        const addBenefitBtn = document.getElementById('addBenefitBtn');
        const submitPolicyBtn = document.getElementById('submitPolicyBtn');
        const customerNumberInputForSearch = document.getElementById('customerNumberInputForSearch');
        const customerNumberForApi = document.getElementById('customerNumberForApi');
        const fetchCustomerBtn = document.getElementById('fetchCustomerBtn');
        const customerStatusP = document.getElementById('customerStatus');
        const benefitErrorP = document.getElementById('benefitError');
        const existingPoliciesSection = document.getElementById('existingPoliciesSection');
        const existingPoliciesContainer = document.getElementById('existingPoliciesContainer');
        const noPoliciesMessage = document.getElementById('noPoliciesMessage');
        const policyNameSelect = document.getElementById('policyName');
        const searchCustomerModal = document.getElementById('searchCustomerModal');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const initialSearchMessage = document.getElementById('initialSearchMessage');
        const resultCountSpan = document.getElementById('resultCount');
        const executeSearchBtn = document.getElementById('executeSearchBtn');
        const searchLoadingSpinner = document.getElementById('searchLoadingSpinner');
        const notificationModal = document.getElementById('notificationModal');

        let domainProductsData = [];
        let benefitCount = 0;

        const availableBenefits = [
            'Guaranteed Annual Payout', 'Death Benefit Provision', 'Critical Illness Rider',
            'Waiver of Premium', 'Inflation Protection', 'Spouse Coverage'
        ];
        
        function getUserCode() {
            // For testing, this can be hardcoded. In a real app, it would come from session/local storage after login.
            let userCode = sessionStorage.getItem('userCode');
             if (!userCode) {
                userCode = 'DEMOUSER01'; // Default user for demo
                sessionStorage.setItem('userCode', userCode);
            }
            return userCode;
        }
        
        async function fetchWithRetry(fn, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        async function apiFetch(url, options = {}) {
            const userCode = getUserCode();
            const headers = { ...options.headers, 'userCode': userCode };
            if (options.body) {
                headers['Content-Type'] = 'application/json';
            }
            return fetchWithRetry(() => fetch(url, { ...options, headers }));
        }

        function checkCustomerNumber(value) {
            fetchCustomerBtn.disabled = value.trim().length === 0;
            customerStatusP.textContent = '';
            if (value.trim().length === 0) {
                clearCustomerFields();
                submitPolicyBtn.disabled = true;
            }
        }

        async function fetchCustomerDetails() {
            const customerNumber = customerNumberInputForSearch.value.trim();
            if (!customerNumber) return;

            customerStatusP.innerHTML = '<span class="text-blue-500"><i class="fas fa-spinner fa-spin mr-1"></i>Fetching...</span>';
            fetchCustomerBtn.disabled = true;

            try {
                const response = await apiFetch(`${PENSION_SERVICE_BASE_URL}/customer-details?customerNo=${customerNumber}`);
                const apiResult = await response.json();

                if (!response.ok) {
                     throw new Error(apiResult.errorMessage || `HTTP error! Status: ${response.status}`);
                }
                
                if (apiResult.data && apiResult.data.length > 0) {
                    autoPopulateForm(apiResult.data[0]);
                    customerStatusP.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Customer details fetched!</span>';
                } else {
                    clearCustomerFields();
                    customerStatusP.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>${apiResult.errorMessage || 'Customer ID not found.'}</span>`;
                }
            } catch (error) {
                console.error("Customer Lookup API Fetch error:", error);
                customerStatusP.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>${error.message}</span>`;
            } finally {
                fetchCustomerBtn.disabled = false;
            }
        }
        
        function autoPopulateForm(customerData) {
            customerNumberInputForSearch.value = customerData.customerNumber || ''; 
            customerNumberForApi.value = customerData.customerNo || '';

            document.getElementById('customerFirstName').value = customerData.name || '';
            document.getElementById('customerMiddleName').value = customerData.middleName || '';
            document.getElementById('customerLastName').value = customerData.surname || '';
            document.getElementById('customerDOB').value = customerData.dateOfBirth || ''; 
            document.getElementById('customerEmail').value = customerData.email || '';
            document.getElementById('customerPhone').value = customerData.phoneNumber || '';
            document.getElementById('customerAddress').value = customerData.address.street+ " " + customerData.address.city+" "+ customerData.address.state+" "+customerData.address.zipCode;
            document.getElementById('customerAadhar').value = customerData.aadharNumber || '';
            document.getElementById('customerPan').value = customerData.panNumber || '';
            document.getElementById('customerDrivingLicense').value = customerData.drivingLicense || '';
            
            const allPolicies = (customerData.policies || []).flatMap(product => product.policies || []);
            renderExistingPolicies(allPolicies); 

            submitPolicyBtn.disabled = false;
        }

        function clearCustomerFields() {
            ['customerFirstName', 'customerMiddleName', 'customerLastName', 
             'customerEmail', 'customerPhone', 'customerDOB', 'customerAddress',
             'customerAadhar', 'customerPan', 'customerDrivingLicense', 'customerNumberForApi'].forEach(id => {
                document.getElementById(id).value = '';
            });
            existingPoliciesSection.style.display = 'none';
            submitPolicyBtn.disabled = true;
        }

        function showSearchCustomerModal() {
            searchCustomerModal.classList.add('active');
            searchResultsContainer.innerHTML = '';
            resultCountSpan.textContent = '0';
            initialSearchMessage.classList.remove('hidden');
        }

        function closeSearchCustomerModal() {
            searchCustomerModal.classList.remove('active');
        }

        async function searchCustomers() {
            const queryParams = new URLSearchParams({
                name: document.getElementById('searchName').value.trim(),
                email: document.getElementById('searchEmail').value.trim(),
                phoneNumber: document.getElementById('searchPhone').value.trim(),
                customerNo: document.getElementById('searchCustomerNo').value.trim()
            });

            for(let p of queryParams){ if(!p[1]) queryParams.delete(p[0]); }
            
            if (Array.from(queryParams).length === 0) {
                searchResultsContainer.innerHTML = '<p class="text-center text-red-500 p-4">Please enter at least one search criteria.</p>';
                return;
            }

            executeSearchBtn.disabled = true;
            document.getElementById('searchText').textContent = 'Searching...';
            searchLoadingSpinner.classList.remove('hidden');
            initialSearchMessage.classList.add('hidden');

            try {
                const response = await apiFetch(`${PENSION_SERVICE_BASE_URL}/customer-details?${queryParams.toString()}`);
                const apiResult = await response.json();
                
                if (!response.ok) {
                    throw new Error(apiResult.errorMessage || `HTTP error! Status: ${response.status}`);
                }
                
                if (apiResult.data && apiResult.data.length > 0) {
                    renderSearchResults(apiResult.data);
                } else {
                    searchResultsContainer.innerHTML = `<p class="text-center text-gray-500 p-4">${apiResult.errorMessage || 'No customers found.'}</p>`;
                }
            } catch (error) {
                console.error("Customer Search API Fetch error:", error);
                searchResultsContainer.innerHTML = `<p class="text-center text-red-500 p-4">Search failed: ${error.message}</p>`;
            } finally {
                executeSearchBtn.disabled = false;
                document.getElementById('searchText').textContent = 'Execute Search';
                searchLoadingSpinner.classList.add('hidden');
            }
        }

        function renderSearchResults(results) {
            resultCountSpan.textContent = results.length;
            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cust. No</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            results.forEach(customer => {
                const fullName = `${customer.name || ''} ${customer.middleName || ''} ${customer.surname || ''}`.trim();
                tableHtml += `<tr class="customer-result-row" onclick='selectCustomerFromSearch(${JSON.stringify(customer)})'>
                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${customer.customerNumber || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${fullName}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${customer.email || 'N/A'}</td>
                </tr>`;
            });
            searchResultsContainer.innerHTML = tableHtml + `</tbody></table>`;
        }
        
        function selectCustomerFromSearch(customerData) {
            autoPopulateForm(customerData);
            customerStatusP.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Customer selected from search!</span>';
            closeSearchCustomerModal();
        }

        async function getDomainProducts() {
            policyNameSelect.innerHTML = '<option value="">-- Fetching... --</option>';
            try {
                const response = await apiFetch(`${PENSION_SERVICE_BASE_URL}/pension-domain`);
                const apiResult = await response.json();
                
                if (!response.ok) {
                     throw new Error(apiResult.errorMessage || 'Failed to load policy products.');
                }
                
                if (apiResult.data && apiResult.data.length > 0) {
                    domainProductsData = apiResult.data;
                    let optionsHtml = '<option value="">-- Select a Policy Product --</option>';
                    domainProductsData.forEach(p => optionsHtml += `<option value="${p.policyName}">${p.policyName}</option>`);
                    policyNameSelect.innerHTML = optionsHtml;
                } else {
                    policyNameSelect.innerHTML = '<option value="">-- No Policies Found --</option>';
                }
            } catch (error) {
                console.error("Domain API Fetch error:", error);
                policyNameSelect.innerHTML = '<option value="">-- Error Loading Policies --</option>';
            }
        }

        function handlePolicySelect(policyName) {
            ['policyTerm', 'premiumAmount', 'paymentFrequency'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('policyStartDate').value = new Date().toISOString().split('T')[0];

            const selectedProduct = domainProductsData.find(p => p.policyName === policyName);
            if (selectedProduct && selectedProduct.policies && selectedProduct.policies.length > 0) {
                const p = selectedProduct.policies[0];
                document.getElementById('policyTerm').value = 10;
                document.getElementById('premiumAmount').value = p.totalAmount; 
                document.getElementById('paymentFrequency').value = (p.policyTerm || 'MONTHLY').toUpperCase();
            }
        }
        
        function renderExistingPolicies(policies) {
            if (!policies || policies.length === 0) {
                noPoliciesMessage.classList.remove('hidden');
                existingPoliciesSection.style.display = 'block';
                return;
            }
            let tableHtml = `<div class="rounded-lg overflow-hidden shadow border border-gray-200"><table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Policy ID</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Premium</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            policies.forEach(p => {
                tableHtml += `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${p.policyId || 0}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${p.policyName || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.policyStatus === 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${p.policyStatus || 'N/A'}</span></td>
                    <td class="px-4 py-3 text-sm text-gray-700 font-semibold">$${(p.totalAmount || 0).toLocaleString()}</td>
                </tr>`;
            });

            existingPoliciesContainer.innerHTML = tableHtml + `</tbody></table></div>`;
            noPoliciesMessage.classList.add('hidden');
            existingPoliciesSection.style.display = 'block';
        }

        function resetForm() {
            form.reset();
            clearCustomerFields();
            customerStatusP.textContent = '';
            benefitsContainer.innerHTML = '';
            benefitCount = 0;
            addBenefitField();
        }
        
        function getSelectedBenefits() {
            return Array.from(document.querySelectorAll('.benefit-select')).map(s => s.value).filter(Boolean);
        }

        function checkDuplicateBenefit(selectElement) {
            const selectedValue = selectElement.value;
            const isDuplicate = getSelectedBenefits().filter(v => v === selectedValue).length > 1;
            benefitErrorP.classList.toggle('hidden', !isDuplicate);
        }

        function addBenefitField() {
            const id = benefitCount++;
            const benefitDiv = document.createElement('div');
            benefitDiv.className = 'flex gap-2 items-center';
            let optionsHtml = '<option value="">Select a Benefit</option>' + availableBenefits.map(b => `<option value="${b}">${b}</option>`).join('');
            benefitDiv.innerHTML = `
                <select id="benefit-${id}" class="input-field benefit-select flex-grow">${optionsHtml}</select>
                <button type="button" class="remove-benefit-btn btn btn-danger"><i class="fas fa-trash-alt !mr-0"></i></button>`;
            benefitsContainer.appendChild(benefitDiv);
            
            benefitDiv.querySelector('.benefit-select').addEventListener('change', (e) => checkDuplicateBenefit(e.target));
            benefitDiv.querySelector('.remove-benefit-btn').addEventListener('click', (e) => {
                e.currentTarget.parentElement.remove();
                checkDuplicateBenefit();
            });
        }
        addBenefitBtn.addEventListener('click', addBenefitField);

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (getSelectedBenefits().filter((v, i, a) => a.indexOf(v) !== i).length > 0) {
                 benefitErrorP.classList.remove('hidden');
                 return;
            }
            benefitErrorP.classList.add('hidden');
            
            const userCode = getUserCode();
            const payload = {
                activityAction: "CREATE",
                userCode: userCode,
                customerProfile: {
                    customerNumber: document.getElementById('customerNumberForApi').value,
                    firstName: document.getElementById('customerFirstName').value,
                    middleName: document.getElementById('customerMiddleName').value,
                    lastName: document.getElementById('customerLastName').value,
                    dateOfBirth: document.getElementById('customerDOB').value,
                    email: document.getElementById('customerEmail').value,
                    phoneNumber: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    aadharNumber: document.getElementById('customerAadhar').value,
                    panNumber: document.getElementById('customerPan').value,
                    drivingLicense: document.getElementById('customerDrivingLicense').value
                },
                policyDetails: {
                    policyName: document.getElementById('policyName').value,
                    policyStartDate: document.getElementById('policyStartDate').value,
                    policyTermYears: parseInt(document.getElementById('policyTerm').value, 10) || null,
                    premiumAmount: parseFloat(document.getElementById('premiumAmount').value) || null,
                    paymentFrequency: document.getElementById('paymentFrequency').value,
                    annuityPayoutOption: document.getElementById('annuityPayoutOption').value
                },
                pensionDetails: {
                    benefitAge: parseInt(document.getElementById('benefitAge').value, 10) || null,
                    benefits: getSelectedBenefits()
                },
                nomineeDetails: {
                    nomineeName: document.getElementById('nomineeName').value,
                    nomineeRelationship: document.getElementById('nomineeRelationship').value,
                    nomineeAadhar: document.getElementById('nomineeAadhar').value,
                    nomineePan: document.getElementById('nomineePan').value,
                    nomineeDrivingLicense: document.getElementById('nomineeDrivingLicense').value
                }
            };
            
            submitPolicyBtn.disabled = true;
            document.getElementById('submitText').textContent = 'Creating...';
            document.getElementById('loadingSpinner').classList.remove('hidden');

            try {
                const response = await apiFetch(`${PENSION_SERVICE_BASE_URL}/createPensionPolicy`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `HTTP Error: ${response.status}`);
                }

                showNotification('Success!', `Pension Policy ${result.policyId || 'N/A'} created successfully for customer ${payload.customerProfile.customerNumber}.`, true);
            } catch (error) {
                showNotification('Submission Failed', `Error: ${error.message}`, false);
            } finally {
                submitPolicyBtn.disabled = false;
                document.getElementById('submitText').textContent = 'Create Policy';
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });
        function showNotification(title, message, isSuccess = true) {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            document.getElementById('notification-title').className = `text-xl font-bold mb-3 ${isSuccess ? 'text-green-600' : 'text-red-600'}`;
            notificationModal.classList.add('active');
        }
        document.getElementById('notification-close-btn').addEventListener('click', () => {
            notificationModal.classList.remove('active');
            resetForm();
        });
        function showCreateCustomerModal() { document.getElementById('createCustomerModal').classList.add('active'); }
		function showBankAccountModal() { document.getElementById('createBankAccountModal').classList.add('active'); }
        function showEditCustomerModal() { document.getElementById('editCustomerModal').classList.add('active'); }
        function closeCustomerModal() { document.getElementById('createCustomerModal').classList.remove('active'); }
        function closeBankAccountModal() { document.getElementById('createBankAccountModal').classList.remove('active'); }
        function closeEditCustomerModal() { document.getElementById('editCustomerModal').classList.remove('active'); }
        
        window.onload = function() {
            addBenefitField();
            getDomainProducts();
            const userCode = getUserCode();
            if (userCode) {
                document.getElementById('userCodeDisplay').textContent = userCode;
                const userInitial = userCode.charAt(0).toUpperCase();
                document.querySelector('#user-menu-button img').src = `https://placehold.co/100x100/E2E8F0/475569?text=${userInitial}`;
            }
        }
    </script>
</body>
</html>